name: Build MLSpp

inputs:
  build_dir:
    required: true
  crypto:
    required: true

runs:
  using: "composite"

  steps:
  - run: |
       git -C vcpkg rev-parse HEAD > vcpkg_commit.txt

  - name: Restore Cache
    uses: actions/cache@v3
    with:
      path: ./build/cache
      key: vcpkg-v1-${{ runner.os }}-${{ hashFiles('vcpkg_commit.txt', 'alternatives/*/vcpkg.json') }}
      restore-keys: |
        vcpkg-v1-${{ runner.os }}
  
  - name: Check OS
    run: |
      echo ${{ runner.os }}

  - name: Dependencies (macOs)
    if: ${{ runner.os == 'macos-latest' }}
    run: |
      brew install llvm pkg-config nasm
      ln -s "/usr/local/opt/llvm/bin/clang-format" "/usr/local/bin/clang-format"
      ln -s "/usr/local/opt/llvm/bin/clang-tidy" "/usr/local/bin/clang-tidy"

  - name: Dependencies (Ubuntu)
    if: ${{ runner.os == 'ubuntu-latest' }}
    run: |
      sudo apt-get install -y linux-headers-$(uname -r) nasm

  - name: Build
    run: |
      cmake -B "${{ inputs.build_dir }}" -DTESTING=ON -DVCPKG_MANIFEST_DIR="alternatives/${{ inputs.crypto }}"
      cmake --build "${{ env.BUILD_DIR }}"

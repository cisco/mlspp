#include <doctest/doctest.h>
#include <hpke/certificate.h>

#include "common.h"

#include <fstream>
#include <iostream>
#include <vector>

#include <tls/compat.h>
namespace opt = tls::opt;

TEST_CASE("Certificate Known-Answer depth 2")
{
  // TODO(suhas) Do this for each supported signature algorithm
  //      ... maybe including a case where parent and child have different
  //      algorithms
  // TODO(suhas) create different cert chains based on depth and algo

  // Chain is of depth 2
  const auto root_der = from_hex(
    "308201083081bba003020102021066144f6b1f7f06eaa3c5c4a24cdfb86f300506032b65"
    "7030143112301006035504031309746573742e636d6f6d301e170d323031303036303231"
    "3234395a170d3230313030373032313234395a3014311230100603550403130974657374"
    "2e636d6f6d302a300506032b65700321001afc1fc100f32f8abb6e7e1635eb873aba8583"
    "b8af948fb07e4b20376a8a89bba3233021300e0603551d0f0101ff0404030202a4300f06"
    "03551d130101ff040530030101ff300506032b6570034100a45de2d187cb28b4a74a4e82"
    "e4a000d68176ae68250803666d3a92b6595b0b0fbdcf231f83542fe29b74a95912a6b71b"
    "8e967f07df14b01b2b4779b233669e02");
  const auto issuing_der = from_hex(
    "3082010d3081c0a00302010202100cf69c4bee7caddc4bdcbd83d7f4e3e5300506032b65"
    "7030143112301006035504031309746573742e636d6f6d301e170d323031303036303231"
    "3234395a170d3230313030373032313234395a30193117301506035504030c0e022e696e"
    "742e746573742e636f6d302a300506032b6570032100ae385adcf6abd78d72bbcc1fdc94"
    "7903875e106c321a63d1367218d654356fd3a3233021300e0603551d0f0101ff04040302"
    "02a4300f0603551d130101ff040530030101ff300506032b65700341007520273c7a32fd"
    "b790c75e7925e53fb32c07add36f1d5c947209865d9ba88a7b2639466d3cf37e69df5667"
    "9d74700077906570c3690f74d944eaa2779ae0cb09");
  const auto leaf_der = from_hex(
    "3081f73081aaa003020102021100fad304f1a5a78be09d01347ed82a04e2300506032b65"
    "7030193117301506035504030c0e022e696e742e746573742e636f6d301e170d32303130"
    "30363032313234395a170d3230313030373032313234395a3000302a300506032b657003"
    "2100f8659f1bbfd057370f86c13c4dbe6850d2184a1b1a899d2d277a54d3666d7625a320"
    "301e300e0603551d0f0101ff0404030202a4300c0603551d130101ff0402300030050603"
    "2b6570034100ec538e976a425f1606e0e3d1f92599ab4a37fdd4deb07d3cf61a1f0f1867"
    "a0518253806c85a793ef5619b5803d4bc72a253a46f770acd65ae6907627e6852002");

  auto root = Certificate{ root_der };
  auto issuing = Certificate{ issuing_der };
  auto leaf = Certificate{ leaf_der };

  REQUIRE(!root.hash().empty());
  REQUIRE(!leaf.hash().empty());
  REQUIRE(!issuing.hash().empty());

  CHECK(root.raw == root_der);
  CHECK(issuing.raw == issuing_der);
  CHECK(leaf.raw == leaf_der);

  CHECK(leaf.valid_from(issuing));
  CHECK(issuing.valid_from(root));
  CHECK(root.valid_from(root));

  CHECK(!leaf.is_ca());
  CHECK(issuing.is_ca());
  CHECK(root.is_ca());

  REQUIRE(root.subject_hash() == 1072860458);
  REQUIRE(issuing.issuer_hash() == root.subject_hash());
  REQUIRE(leaf.issuer_hash() == issuing.subject_hash());

  // negative tests
  CHECK_FALSE(issuing.valid_from(leaf));
  CHECK_FALSE(root.valid_from(issuing));
  CHECK_FALSE(root.valid_from(leaf));
}

TEST_CASE("Certificate Known-Answer depth 2 with SKID/ADID")
{
  const auto root_der = from_hex(
    "308201183081cba0030201020211009561abf361bd738664041a79d918f602300506032b"
    "657030143112301006035504031309746573742e636d6f6d301e170d3230313030363035"
    "303433365a170d3230313030373035303433365a30143112301006035504031309746573"
    "742e636d6f6d302a300506032b657003210047f0149110ed81e2beaabbc3699527bdb8b7"
    "45da010da7fb8301d06fff8239e4a3323030300e0603551d0f0101ff0404030202a4300f"
    "0603551d130101ff040530030101ff300d0603551d0e04060404b9e672b8300506032b65"
    "70034100e15b54d50d1354f44017c5f8a037228546256c5fa1d750758fdf76f7e1dc246e"
    "7c67c18226ffd6704327bbae9a0cf5bd209facdcb524dc7efa517d1155487a0e");
  const auto issuing_der = from_hex(
    "3082012e3081e1a003020102021100919fc6cb4ea1a73766c95ada9a476aee300506032b"
    "657030143112301006035504031309746573742e636d6f6d301e170d3230313030363035"
    "303433365a170d3230313030373035303433365a30193117301506035504030c0e022e69"
    "6e742e746573742e636f6d302a300506032b6570032100c0a9d461880d82db662e984a8c"
    "06f74479817952070ea8cd0010971bc793ab9ca3433041300e0603551d0f0101ff040403"
    "0202a4300f0603551d130101ff040530030101ff300d0603551d0e0406040475ecb84430"
    "0f0603551d23040830068004b9e672b8300506032b6570034100e72bf92a39bab96649ab"
    "bd619c47b054bf7b071ceb24710ad253682d1df7690b0a1ef28ef8a2f76c3b8f2fed9d11"
    "3a61c98768db30d16fe6d9a36595775d110e");
  const auto leaf_der = from_hex(
    "308201163081c9a0030201020210291fb8fb96d2c215cb2d532f252d80e4300506032b65"
    "7030193117301506035504030c0e022e696e742e746573742e636f6d301e170d32303130"
    "30363035303433365a170d3230313030373035303433365a3000302a300506032b657003"
    "210032e4be5553d2141ace4da105fdf632da3467f013581f57dbd4f09706fa99949da340"
    "303e300e0603551d0f0101ff0404030202a4300c0603551d130101ff04023000300d0603"
    "551d0e04060404dd3b0790300f0603551d2304083006800475ecb844300506032b657003"
    "4100314a485d01df4c7852ec5720b2af34f5620b2a32a50c4ee0481d013ebbfd8e243784"
    "123a0cfe4d59b1fb09a1738ee9bc2aab59a2b4af2c3ee60ce19afbe1eb03");

  const auto root_skid = std::string("b9e672b8");
  const auto issuing_skid = std::string("75ecb844");
  const auto leaf_skid = std::string("dd3b0790");

  auto root = Certificate{ root_der };
  auto issuing = Certificate{ issuing_der };
  auto leaf = Certificate{ leaf_der };

  CHECK(root.raw == root_der);
  CHECK(issuing.raw == issuing_der);
  CHECK(leaf.raw == leaf_der);

  CHECK(leaf.valid_from(issuing));
  CHECK(issuing.valid_from(root));
  CHECK(root.valid_from(root));

  REQUIRE(leaf.subject_key_id().has_value());
  REQUIRE(leaf.authority_key_id().has_value());

  REQUIRE(issuing.subject_key_id().has_value());
  REQUIRE(issuing.authority_key_id().has_value());

  REQUIRE(root.subject_key_id().has_value());

  CHECK_EQ(to_hex(opt::get(leaf.subject_key_id())), leaf_skid);
  CHECK_EQ(to_hex(opt::get(leaf.authority_key_id())),
           to_hex(opt::get(issuing.subject_key_id())));
  CHECK_EQ(to_hex(opt::get(issuing.subject_key_id())), issuing_skid);
  CHECK_EQ(to_hex(opt::get(issuing.authority_key_id())),
           to_hex(opt::get(root.subject_key_id())));
  CHECK_EQ(to_hex(opt::get(root.subject_key_id())), root_skid);
}

TEST_CASE("Certificate Known-Answer depth 2 with SAN RFC822Name")
{
  const auto root_der = from_hex(
    "3081ff3081b2a00302010202101025963d9aefe2cdaf9c8017b9836b9b300506032b657030"
    "00301e170d3230313132353232333135365a170d3230313132363232333135365a3000302a"
    "300506032b65700321006fd52c993c4554c550c6f57a8c9b44834a99889c882e597d78e952"
    "afdbde748ea3423040300e0603551d0f0101ff0404030202a4300f0603551d130101ff0405"
    "30030101ff301d0603551d110101ff04133011810f7573657240646f6d61696e2e636f6d30"
    "0506032b6570034100accb5e7e05e607ca0c5a9103e962e360ea0b95ab8c876993af2660ef"
    "7e22ae6714f3d7b6b9594ac3eaaeeef263f764bc4939c84005db311ac4740b665694b004");
  const auto issuing_der = from_hex(
    "3081ff3081b2a0030201020210277bfa0157eaa84f1dc14c07ade455dd300506032b657030"
    "00301e170d3230313132353232333135365a170d3230313132363232333135365a3000302a"
    "300506032b65700321005ddafa25a2313f8dd19be29736825207a67282c2c6e327b8ac5127"
    "102e0d4eeda3423040300e0603551d0f0101ff0404030202a4300f0603551d130101ff0405"
    "30030101ff301d0603551d110101ff04133011810f7573657240646f6d61696e2e636f6d30"
    "0506032b6570034100eea828a18197fd4bd5751959318a7def21ce0c588b4107dc51ab6eb3"
    "e1a0a7c440cc019c186fbdbe227c0f368ab993c8a5af5c9681e11583d0442cafcaf01300");
  const auto leaf_der = from_hex(
    "3081fd3081b0a003020102021100af5442db77d60c749fffe8eebf193afa300506032b6570"
    "3000301e170d3230313132353232333135365a170d3230313132363232333135365a300030"
    "2a300506032b6570032100885cc6836723e204b54275c97928481c55b149e1ed0e22b30d2f"
    "1a89aa24e2d1a33f303d300e0603551d0f0101ff0404030202a4300c0603551d130101ff04"
    "023000301d0603551d110101ff04133011810f7573657240646f6d61696e2e636f6d300506"
    "032b65700341002cc5b3f1a8954ccc872ecddf5779fb007c08ebc869227dec09cfba8fd977"
    "ea49a182a2e51b67d4440d42248f6951f4c765e9e72e301225c953e89b2747129a0c");

  auto root = Certificate{ root_der };
  auto issuing = Certificate{ issuing_der };
  auto leaf = Certificate{ leaf_der };

  CHECK(leaf.valid_from(issuing));
  CHECK(issuing.valid_from(root));
  CHECK(root.valid_from(root));

  CHECK_EQ(leaf.email_addresses().at(0), "user@domain.com");
}

TEST_CASE("RSA-SHA256 Certificate Known-Answer depth 2")
{
  const auto root_der = from_hex(
    "308202dc308201c4a0030201020211009f3b55576e66866d81ac2aff814dd078300d06092a"
    "864886f70d01010b05003000301e170d3231303130383033333533385a170d323130313039"
    "3033333533385a300030820122300d06092a864886f70d01010105000382010f003082010a"
    "0282010100e406fa017bbc10efda6b2c04b1b6c02a2b7023afab14f39c0e191601aff0b180"
    "08b4c8baf623d94f3ef535398a6507ac0d6af8220a57ce01aedeca1685c817abc4210a779b"
    "951079b02499a9c01247a7a778c8cdffff372910dbf09a416627cf195a3de975d7d424372f"
    "c8f7977aa21c16549373b13d52356e2ade101632edc5dbfc405399f4bbfbd7d2e0128c6b33"
    "bebc9b7b471d1e39c4d94930c941a205c30f1529fe63adbd71a4354cd0e6c3c29f42c10ed3"
    "5fbba07319e8d6d251ee89fcfb1ed280d5614b50f703d13adc04743c182fd8240d318b3008"
    "cae0643d0253aea819ded8281d5d68cbf241a16b9208e2de649bbb2f2a9a0be09b48ff2cc7"
    "e39b0203010001a351304f300e0603551d0f0101ff0404030202a4300f0603551d130101ff"
    "040530030101ff300d0603551d0e0406040496014f01301d0603551d110101ff0413301181"
    "0f7573657240646f6d61696e2e636f6d300d06092a864886f70d01010b05000382010100bf"
    "36d99f9e33360cbc1a6ac5cc3a7fde03ec6f6c5ca397bcd1f26b359c7e6b1f18ceaad7a901"
    "9f517bac8c1f391735a290c0fc7a8c82d19ed39da400f4fd3799cb9b0fb915bb47b10bf70d"
    "3bb1b94b534c2cc17c033d78cbef82c62c634f72ea939bee9127feb0b510cb616af2aaeb68"
    "7e984a414c1459ea2053836c28ad0bdb1bea034ea53bc45aa242e706f5bd60c20bfbd3b438"
    "3aefa38faf51aca860f217a580cecca5a9a17c1a469e635b3e5d35f44b4480d5b744abf149"
    "809886f71df9b38c3d464cc28dc9f7b5db0883b8acdd5a620b75abfbeb50b8e07258edd21b"
    "4390e220d2826074409468d80332d5ce593321dabd68c24ca2b26f09881632e81c");
  const auto issuing_der = from_hex(
    "308202db308201c3a003020102021055fe8d63eed32050a48a7759f502ea23300d06092a86"
    "4886f70d01010b05003000301e170d3231303130383033333533385a170d32313031303930"
    "33333533385a300030820122300d06092a864886f70d01010105000382010f003082010a02"
    "82010100c192285946858f865ec8d72fc14a4bd8d90e3ae4ff796f8d5c07d50613d7435251"
    "a9d29866d00ea26a6b3475201c3774e720d55d9043a21c2c3d7a2e7ae385202448895fb287"
    "19db9a21e27de8d8a13e45b10a9ccdc64a602e7fbe2247eb67c092e6210ccc860d7185e117"
    "e65ab497b03cb82aa1d15116b5fbd5883c0c59eca5ca0bc2a339af41f5c2040fd3f15a6616"
    "46b25bfaf7cac060b0cfcd32e641c80e1eeb200ef748b4bbf71626e5c5cfd38e36a6ac2468"
    "9c822c7bd9bd5ce81c8267ebc8aa1da34cc80901b905b9fd5905f8d38e350a190d82f8a259"
    "0f50a64bf514f1f1e3eb517d7b67f58bbc3f924705037d78c24b5b35cc457a651e73c47b6b"
    "970203010001a351304f300e0603551d0f0101ff0404030202a4300f0603551d130101ff04"
    "0530030101ff300d0603551d0e04060404f375df9a301d0603551d110101ff04133011810f"
    "7573657240646f6d61696e2e636f6d300d06092a864886f70d01010b05000382010100485b"
    "3866b842590ceeeb36b861a1fd6aa980f7f01982f622c08bf61f10c7bba098bb63d395338a"
    "b6dbd80d93dca2bd4d221342cc0d0b370b4fa4663d1a7189d7d0e048fe0a2ff642e16e5050"
    "e2b02541457573de067f6ff6da9d686f4cf29b29fd06739e166e74e20e6471820515ca51e5"
    "7f0bf749036a48d69d8bf17aa48dadc59f3a5042ee5ba03915bdb25aaf1bc045574fec8ded"
    "e70f202a84004321bb4eca4cc6f41bf9152374abb1964f384af33ffccd052d2349f4968945"
    "4f3e486aa8af9a585b37339472ffab13c8eec91cfef52fecc474e76ebae097f35982646a48"
    "a9dd59afcb5109d9aec181f41db10993cfa1260aee0225238430beecd2fbc1af");
  const auto leaf_der = from_hex(
    "308202d8308201c0a00302010202106e29bc66c0bd4beecdcfca0206dc0fd7300d06092a86"
    "4886f70d01010b05003000301e170d3231303130383033333533385a170d32313031303930"
    "33333533385a300030820122300d06092a864886f70d01010105000382010f003082010a02"
    "82010100bce6b1c1698ac7814bb2a90f2bf2f312fea68005de63f3c351a3c177666199b77a"
    "4b4c0862ec86694e3a5133d969b80583676a1b439f75546ab5b521e1254bccf8f2533f452d"
    "2cc94656c277f5e2de683c2b1824c3ffa2ead581c17cf8207b81f8803a7fa6e477de7e0bd4"
    "b02262ee3a8cbfee2b4b57bb3626ad13e12a6ac4e781c45371deb2bda233f054aefd6c3618"
    "47d7e1a5757fa4bbeed8712871f22bc46c383491ed3c3718896298e6bcd498f7fbcc6af292"
    "78a5ed5a95a65ee03892a166559332621de95dbfd45979099e788d61c98683ec39b7c4fbb7"
    "59bf08b9f74baaf157a82f4e6f26eb16f684be49af9d58bfb4f0ff65f924d0b3994b4ea761"
    "8f0203010001a34e304c300e0603551d0f0101ff0404030202a4300c0603551d130101ff04"
    "023000300d0603551d0e0406040409682fe0301d0603551d110101ff04133011810f757365"
    "7240646f6d61696e2e636f6d300d06092a864886f70d01010b05000382010100949426508f"
    "08f3c05219d736234cddda0dfc6da3973ded235755bf5ed427cd61c041dcc3671c0acd82c1"
    "5cc297debb60d9bdd3e4350e2c62c8adb241281e9907b1f6d6171ab3e48ca49dacb43d9828"
    "844249d28973edc5d99e7d1c94809745ec6d6a0360a5bad6c0f51fcf44c50edc00d12273d2"
    "ba580cbabd112d2338e83c1cf8c3ddfee8ec0aac6c6251c224b5ae92153afa8cd33d2dab05"
    "46213b63501aba095ddb5ab43699ef2aa201b4552b2aa97f15ca7d8708f630370a9cdaa182"
    "59ccf1736a59d8d4da9969d7ae06be41cce68fdd263a5c9a9658e80d9a4ad6bf51f1a39082"
    "4059cf88a84fd70b72349602d3224b9878e72d0e7e7cffea35fcf36da5");

  auto root = Certificate{ root_der };
  auto issuing = Certificate{ issuing_der };
  auto leaf = Certificate{ leaf_der };

  CHECK(root.raw == root_der);
  CHECK(issuing.raw == issuing_der);
  CHECK(leaf.raw == leaf_der);

  CHECK(leaf.valid_from(issuing));
  CHECK(issuing.valid_from(root));
  CHECK(root.valid_from(root));

  CHECK(!leaf.is_ca());
  CHECK(issuing.is_ca());
  CHECK(root.is_ca());

  REQUIRE(issuing.issuer_hash() == root.subject_hash());
  REQUIRE(leaf.issuer_hash() == issuing.subject_hash());

  // negative tests
  CHECK_FALSE(issuing.valid_from(leaf));
  CHECK_FALSE(root.valid_from(issuing));
  CHECK_FALSE(root.valid_from(leaf));
}

TEST_CASE("RSA-SHA384 Certificate Known-Answer depth 2")
{
  // https://crt.sh/?id=8559455
  const auto root_der = from_hex(
    "3082059030820378a0030201020210059b1b579e8e2132e23907bda777755c300d06092a86"
    "4886f70d01010c05003062310b300906035504061302555331153013060355040a130c4469"
    "67694365727420496e6331193017060355040b13107777772e64696769636572742e636f6d"
    "3121301f060355040313184469676943657274205472757374656420526f6f74204734301e"
    "170d3133303830313132303030305a170d3338303131353132303030305a3062310b300906"
    "035504061302555331153013060355040a130c446967694365727420496e63311930170603"
    "55040b13107777772e64696769636572742e636f6d3121301f060355040313184469676943"
    "657274205472757374656420526f6f7420473430820222300d06092a864886f70d01010105"
    "000382020f003082020a0282020100bfe6907368debbe45d4a3c3022306933ecc2a7252ec9"
    "213df28ad859c2e129a73d58ab769acdae7b1b840dc4301ff31ba43816eb56c6976d1dabb2"
    "79f2ca11d2e45fd6053c520f521fc69e15a57ebe9fa95716595572af689370c2b2ba75996a"
    "733294d11044102edf82f30784e6743b6d71e22d0c1bee20d5c9201d63292dceec5e4ec893"
    "f821619b34eb05c65eec5b1abcebc9cfcdac34405fb17a66ee77c848a86657579f54588e0c"
    "2bb74fa730d956eeca7b5de3adc94f5ee535e731cbda935edc8e8f80dab69198409079c378"
    "c7b6b1c4b56a183803108dd8d437a42e057d88f5823e109170ab55824132d7db04732a6e91"
    "017c214cd4bcae1b03755d7866d93a31449a3340bf08d75a49a4c2e6a9a067dda427bca14f"
    "39b5115817f7245c468f64f7c169887698763d595d4276878997697a48f0e0a2121b669a74"
    "cade4b1ee70e63aee6d4ef92923a9e3ddc00e4452589b69a44192b7ec094b4d2616deb33d9"
    "c5df4b0400cc7d1c95c38ff721b2b211b7bb7ff2d58c702c4160aab1631844951a76627ef6"
    "80b0fbe864a633d18907e1bdb7e643a418b8a67701e10f940c211db2542925896ce50e5251"
    "4774be26acb64175de7aac5f8d3fc9bcd34111125be51050eb31c5ca72162209df7c4c753f"
    "63ec215fc420516b6fb1ab868b4fc2d6455f9d20fca11ec5c08fa2b17e0a2699f5e4692f98"
    "1d2df5d9a9b21de51b0203010001a3423040300f0603551d130101ff040530030101ff300e"
    "0603551d0f0101ff040403020186301d0603551d0e04160414ecd7e382d2715d644cdf2e67"
    "3fe7ba98ae1c0f4f300d06092a864886f70d01010c05000382020100bb61d97da96cbe17c4"
    "911bc3a1a2008de364680f56cf77ae70f9fd9a4a99b9c9785c0c0c5fe4e61429560b36495d"
    "4463e0ad9c9618661b230d3d79e96d6bd654f8d23cc14340ae1d50f552fc903bbb9899696b"
    "c7c1a7a868a427dc9df927ae3085b9f6674d3a3e8f5939225344ebc85d03caed507a7d6221"
    "0a80c87366d1a005605fe8a5b4a7afa8f76d359c7c5a8ad6a23899f3788bf44dd2200bde04"
    "ee8c9b4781720dc01432ef30592eaee071f256e46a976f92506d968d687a9ab236147a06f2"
    "24b9091150d708b1b8897a8423614229e5a3cda22041d7d19c64d9ea26a18b14d74c19b250"
    "41713d3f4d7023860c4adc81d2cc3294840d0809971c4fc0ee6b207430d2e0393410852115"
    "0108e85532de7149d92817504de6be4dd175acd0cafb41b843a5aad3c305444f2c369be2fa"
    "e245b823536c066f67557f46b54c3f6e285a7926d2a4a86297d21ee2ed4a8bbc1bfd474a0d"
    "df67667eb25b41d03be4f43bf40463e9efc2540051a08a2ac9ce78ccd5ea870418b3ceaf49"
    "88aff39299b6b3e6610fd28500e7501ae41b959d19a1b99cb19bb1001eefd00f4f426cc90a"
    "bcee43fa3a71a5c84d26a535fd895dbc85621d32d2a02b54ed9a57c1dbfa10cf19b78b4a1b"
    "8f01b6279553e8b6896d5bbc68d423e88b51a256f9f0a680a0d61eb3bc0f0f537529aaea13"
    "77e4de8c8121ad07104711ad873d07d175bccff3667e");

  // https://crt.sh/?id=5818560
  const auto issuing_der = from_hex(
    "3082065c30820444a003020102021003637e538cfd86e1603527d6f2b80ff4300d06092a86"
    "4886f70d01010c05003062310b300906035504061302555331153013060355040a130c4469"
    "67694365727420496e6331193017060355040b13107777772e64696769636572742e636f6d"
    "3121301f060355040313184469676943657274205472757374656420526f6f74204734301e"
    "170d3133303830313132303030305a170d3238303830313132303030305a304c310b300906"
    "035504061302555331153013060355040a130c446967694365727420496e63312630240603"
    "550403131d4469676943657274205472757374656420536572766572204341204734308202"
    "22300d06092a864886f70d01010105000382020f003082020a0282020100d2c7a519430712"
    "4ab63c8e5b68af465758769bd5ef27a26c65ed4deeec5046111ec121ccd81cabae6be33a99"
    "942c502d1e317776bc1644a0cc03908c7ded854be6c72aab0e63664b9fc0fea834546a0d60"
    "af1d0fc3de9ad403e7d39d0e59908be22cb5bcb4bbbffee06470254e718d754ab1a7e55519"
    "d237d5aadbc4350eaad35f4c2ddf7c17d704d7a1d94eabd783a7a55ffe93e1807b92264157"
    "e926967022f9fff53957876b6cd95808087c0a508a6b81a2dba345120fdc86739f13cfeee8"
    "766a8b3d3e5e71647497e682916f875cc02e1d8b81aec3d79b9b91259a2e1b4d5fa1ad8b11"
    "21614aa9493788386ff4479a839c91f1cb8f5cb7f27acd520beaa1e235a2cced14884eeb87"
    "3cb9b8f1ac619ccfb4508bfd3c98b99cd09de8edd60ab9047771517f3811dab9c79affacd7"
    "b7496a7a746b969a7bca76c33e4ade0e4de97074e16097c8995d3646e6782ed3753f5f88eb"
    "696f6cf12084d1c0003be4577bceb29d3e8af40aa9ad7b76dd048ea9312925829dc07dede6"
    "71fab4880136c17d5834e081e1b946826f80eff56475c7e14bd849c6b502cc222df25914ce"
    "fce65561d0c4b6aebb2be3dd9a880f6e70fbbced771b66dad56ce749bf664a9ed9e2ea1423"
    "c1c7e708771c20dbd9322903758cd4585d55928cd180b0aa3dabb7d91c7696666e5e154ad4"
    "a84d93ceec23e619c751d495c258f4c7d6b3f8182a319a010203010001a38201223082011e"
    "30120603551d130101ff040830060101ff020100300e0603551d0f0101ff04040302018630"
    "3406082b0601050507010104283026302406082b060105050730018618687474703a2f2f6f"
    "6373702e64696769636572742e636f6d30430603551d1f043c303a3038a036a03486326874"
    "74703a2f2f63726c342e64696769636572742e636f6d2f4469676943657274547275737465"
    "64526f6f7447342e63726c303d0603551d200436303430320604551d2000302a302806082b"
    "06010505070201161c68747470733a2f2f7777772e64696769636572742e636f6d2f435053"
    "301d0603551d0e0416041436d0a89e89f282bc6be259b6a3c6f734468cb42f301f0603551d"
    "23041830168014ecd7e382d2715d644cdf2e673fe7ba98ae1c0f4f300d06092a864886f70d"
    "01010c050003820201004bfdfe77bd686ab1849c888711d6423033f20f8f2acbaddc423bfb"
    "8a8b1d33836ea06955c638bc361ef07f4c4afb40282b8bce7b6bfc3b0ff4c33672f38c662b"
    "41ed8a0588f624ed192af8f93ad75555d8255e861308831abf636b94d9ede6dd313a26ad6a"
    "39a565672c20a83f44d66536155badaaa83a66ce9317ecb79fe49c49a67556786de9537db1"
    "eb85be424a7bd64bf8aa819eb2e6480ae4d36d3417a08f3a9a428220f1950ba527aff658ad"
    "6ae8766e030c2a7938948b64f8a731b608163b2ab7d02d6ec952abca21df06ecb73b3cc215"
    "64bbcb5a3362d6d7d21a8b65c3e7025ee93f67d5eea904ffcf4a76450a95afe783f7cc9289"
    "4457faf07db4b3a58e982b1763dfc6bd79e9b89ccacc8bb2e74ac8a6a0d4d7c3994f2c7751"
    "7748576262f4b09e82eb1fbb616a926f887d05ea30804fab788b60fde8e8561553c638de7b"
    "0e9af9c0c74d1d374366c2c2f77ae88cab78ba4b3de344a2ef5497f75f05d0682fa1555381"
    "d5a0e5d4537cec245c590919f77187b067bce024d4fa005805b951c20484f4499af7c3e938"
    "3f57aa38c191595f5c92b44f6acde9c3abb5e3da3bd3d7b01503fb803563876522548439c3"
    "7391321282c99da9f6b7a2d8f15244b3d7414648f6fd49abd85c021695ccf1a88bd7ca6fd3"
    "d5d9a4619356d467af432582cc2ee4f1142840520c72bd24dfcdc145bfa87d49242984071b"
    "262c907f");

  // https://crt.sh/?id=2870518080
  const auto leaf_der = from_hex(
    "308206ce308204b6a00302010202100c1ac940a29b6c752634065a45db7931300d06092a86"
    "4886f70d01010b0500304c310b300906035504061302555331153013060355040a130c4469"
    "67694365727420496e63312630240603550403131d44696769436572742054727573746564"
    "20536572766572204341204734301e170d3230303532393030303030305a170d3231303630"
    "393132303030305a306e310b3009060355040613024742310f300d060355040713064c6f6e"
    "646f6e31243022060355040a131b47726579436173746c65205365727669636573204c696d"
    "69746564310b3009060355040b13024954311b3019060355040313126d69732e6772657963"
    "6173746c652e636f6d308201a2300d06092a864886f70d01010105000382018f003082018a"
    "0282018100c8295feb036701bec6ba45931fafa32f24a99165930c43e0a80bab8a900243aa"
    "ab817e9d1c4ae9ebf3623a8d84d90de7d548207beecd5539f11ef201ac0acdae6f7a62bc98"
    "9ea76fa6367b175732488fcbeaa5e2af80a41db51e484adf7cd42c312175090e50b116caa7"
    "fa2f631742dd73babdec27ce524ecabb2196161c8102ef95060d9d4755c8cdfdf65a9a9bd2"
    "5bd6a137e9bfef8ce769e72b312d190d87720570accc1a322f7476f1a94761900ea57cc0a7"
    "bd3f472eb7565ebb1a2009da6bc405834816a04a474c48dd8eee3ee837aada5cc539bee734"
    "b9b917f1dcad32532e1594c05b050e2bfd9123b5417da7608a112e5570fa5077429b6921c2"
    "c0e8ce21aa24285ebb55474a1953018efbb2cbf0ecc7a9f401cb94e68f49bb8262095a67d1"
    "4aa16e2af42f2ed10466d7604d08e4b63d5e72eb992e2ed41d8b5719888cd3fefb5c97413e"
    "68aa38b4404499eec663a776287518a6c52bc7272f61b7791c868d3017d41924eeb4608a79"
    "c9910a973db1bcd06c3e8be758bd9b11f29f2b0203010001a382020830820204301f060355"
    "1d2304183016801436d0a89e89f282bc6be259b6a3c6f734468cb42f301d0603551d0e0416"
    "04147cc743f92cc1a492021139fff23e8b22ea1b75d6301d0603551d110416301482126d69"
    "732e67726579636173746c652e636f6d300e0603551d0f0101ff0404030205a0301d060355"
    "1d250416301406082b0601050507030106082b060105050703023081850603551d1f047e30"
    "7c303ca03aa0388636687474703a2f2f63726c332e64696769636572742e636f6d2f446967"
    "694365727454727573746564536572766572434147342e63726c303ca03aa0388636687474"
    "703a2f2f63726c342e64696769636572742e636f6d2f446967694365727454727573746564"
    "536572766572434147342e63726c304c0603551d2004453043303706096086480186fd6c01"
    "01302a302806082b06010505070201161c68747470733a2f2f7777772e6469676963657274"
    "2e636f6d2f4350533008060667810c010202307b06082b06010505070101046f306d302406"
    "082b060105050730018618687474703a2f2f6f6373702e64696769636572742e636f6d3045"
    "06082b060105050730028639687474703a2f2f636163657274732e64696769636572742e63"
    "6f6d2f446967694365727454727573746564536572766572434147342e637274300c060355"
    "1d130101ff040230003013060a2b06010401d6790204030101ff04020500300d06092a8648"
    "86f70d01010b05000382020100a69ec6a9de43963a9f6282f2e5d9804d47f3827bd1cf1e14"
    "d52f16f0c154e383b75ca22f2c1fb0be22225f6e31ae89d7cfb56dd185b8561eb9e146e3d3"
    "71e4d43edc93ddfd743f6e7ce75c2c5695a5784f76595ace03b27a902ecb8e6b48d3e27c67"
    "42cf937a219f8c6a5e135775222e744f051262c1eefabd2252dc7f205f2f5a049b710ca1f5"
    "9495cf9a20b67018aa4d7f022de7a2748ded9b20f25c8b4156b691d1a67793dfd79875c895"
    "924151780fb3c97365f494779c7b24ab2cc7d2c4b55e02958e4b05e2cbd6e4ca4289eefa55"
    "550118f389cecae0edcad5b73199a42219c3c0daba5c813d39b51b9c63e683d847cde26800"
    "9e67a6782e85e8553b647d79f11a933493cb43fb853866841baf7665a1f979dabb7cb58bb4"
    "97822d245880e0701d7eeb43eefa8cd87e3a00d62fec0d8362b4a04cadaf78b793875acf02"
    "b43c07bcc4cfac001be2e1559cc7b49bcfc0b25b1d34ed194ef2d613ffe2b60235677e409c"
    "709a273ecfb5e656dc3291dd55b1ac98434033640ecfd857a87ea4fa4e39e98d1b4ea8e534"
    "5aed85e40966c85cc66fa54139891f74b4313715ffca51f9e67107d5cb951eb07cba6e34b6"
    "f0d9ad973e4998f098c7e2096e6c12cdb64fe5836d5c184c2e38f917df5015c43945eedcaf"
    "5e75bc581f4135f898eaecff22fdadcdacefabdd433e2daa6d69efcc0a3bad9370e70994bd"
    "246e5461c4c59d");

  auto root = Certificate{ root_der };
  auto issuing = Certificate{ issuing_der };
  auto leaf = Certificate{ leaf_der };

  CHECK(root.raw == root_der);
  CHECK(issuing.raw == issuing_der);
  CHECK(leaf.raw == leaf_der);

  CHECK(leaf.valid_from(issuing));
  CHECK(issuing.valid_from(root));
  CHECK(root.valid_from(root));

  CHECK(!leaf.is_ca());
  CHECK(issuing.is_ca());
  CHECK(root.is_ca());

  REQUIRE(issuing.issuer_hash() == root.subject_hash());
  REQUIRE(leaf.issuer_hash() == issuing.subject_hash());

  // negative tests
  CHECK_FALSE(issuing.valid_from(leaf));
  CHECK_FALSE(root.valid_from(issuing));
  CHECK_FALSE(root.valid_from(leaf));
}

TEST_CASE("Ecdsa p256 Certificate")
{
  // ecdsa-p256 cert chain
  const auto root_der = from_hex(
    "3082014d3081f5a003020102021038247e1ba3468e9913ab357d9e106abe300a06082a8648"
    "ce3d0403023000301e170d3231303132393035343232305a170d3231303133303035343232"
    "305a30003059301306072a8648ce3d020106082a8648ce3d03010703420004dea4dc4bb1c9"
    "824c471efeaab03f74eb243e15388cd5df912ad3ab46c97351a41323975a9c985fbd95d78a"
    "40b4411368ce9a4cd4db7eb3c3962d59870cb783bfa351304f300e0603551d0f0101ff0404"
    "030202a4300f0603551d130101ff040530030101ff300d0603551d0e04060404927b64c630"
    "1d0603551d110101ff04133011810f7573657240646f6d61696e2e636f6d300a06082a8648"
    "ce3d0403020347003044022078e8cab207d4cf86010a5e2193d47c150c3faebe7f45fcadd7"
    "225c4c80d7ee2302203373b4d283d0417de2a3f27b3470b0137b80001715f99e05284e8b16"
    "ed288540");
  const auto issuing_der = from_hex(
    "3082014f3081f5a00302010202101397ccc4e13819f59adffea8f5aa55ba300a06082a8648"
    "ce3d0403023000301e170d3231303132393035343232305a170d3231303133303035343232"
    "305a30003059301306072a8648ce3d020106082a8648ce3d030107034200045e210200da76"
    "c73e9da9c9c3ff68fb680d12b60633c29cc4ec8aa66e4be2cde4f21e706dd64aaa2adda116"
    "f4d5474d6689a7205835fd5a13ecd46b64a71c807ca351304f300e0603551d0f0101ff0404"
    "030202a4300f0603551d130101ff040530030101ff300d0603551d0e04060404f312fa8f30"
    "1d0603551d110101ff04133011810f7573657240646f6d61696e2e636f6d300a06082a8648"
    "ce3d0403020349003046022100a4f4defca4ed13b781b797707670bdf885d1aa6cf8a5d9ba"
    "586066ada8cca961022100e26d5a5c7cf169e820bb3c5fb1a8e8a9f48678d46cf7d489270c"
    "98546efa46fb");
  const auto leaf_der = from_hex(
    "3082014a3081f2a003020102021003d61b85fa16a9439b2a9c9dcd9ee575300a06082a8648"
    "ce3d0403023000301e170d3231303132393035343232305a170d3231303133303035343232"
    "305a30003059301306072a8648ce3d020106082a8648ce3d03010703420004177f3e44f97d"
    "36df7e7216857e4ce511a2e402376a59d9887b90c59351bd7cca387c0cc22a25038a1532df"
    "ec82b49661ad38ad21acfaca9adb524e3761b1943fa34e304c300e0603551d0f0101ff0404"
    "030202a4300c0603551d130101ff04023000300d0603551d0e04060404db6458df301d0603"
    "551d110101ff04133011810f7573657240646f6d61696e2e636f6d300a06082a8648ce3d04"
    "0302034700304402201dc0f17ab8f980bb8a13ad1003325fe237af78f7338ef2dbf383a493"
    "191217d402203505672d488ea336a70be868ceb69dbd163f437942fb4ea3ef1a844cb4927d"
    "0e");

  auto root = Certificate{ root_der };
  auto issuing = Certificate{ issuing_der };
  auto leaf = Certificate{ leaf_der };

  REQUIRE(!root.hash().empty());
  REQUIRE(!leaf.hash().empty());
  REQUIRE(!issuing.hash().empty());

  CHECK(root.raw == root_der);
  CHECK(issuing.raw == issuing_der);
  CHECK(leaf.raw == leaf_der);

  CHECK(leaf.valid_from(issuing));
  CHECK(issuing.valid_from(root));
  CHECK(root.valid_from(root));

  CHECK(!leaf.is_ca());
  CHECK(issuing.is_ca());
  CHECK(root.is_ca());

  // negative tests
  CHECK_FALSE(issuing.valid_from(leaf));
  CHECK_FALSE(root.valid_from(issuing));
  CHECK_FALSE(root.valid_from(leaf));
}

TEST_CASE("PEM parsing")
{
  // ecdsa-p256 cert chain
  const auto root_der = from_hex(
    "3082014d3081f5a003020102021038247e1ba3468e9913ab357d9e106abe300a06082a8648"
    "ce3d0403023000301e170d3231303132393035343232305a170d3231303133303035343232"
    "305a30003059301306072a8648ce3d020106082a8648ce3d03010703420004dea4dc4bb1c9"
    "824c471efeaab03f74eb243e15388cd5df912ad3ab46c97351a41323975a9c985fbd95d78a"
    "40b4411368ce9a4cd4db7eb3c3962d59870cb783bfa351304f300e0603551d0f0101ff0404"
    "030202a4300f0603551d130101ff040530030101ff300d0603551d0e04060404927b64c630"
    "1d0603551d110101ff04133011810f7573657240646f6d61696e2e636f6d300a06082a8648"
    "ce3d0403020347003044022078e8cab207d4cf86010a5e2193d47c150c3faebe7f45fcadd7"
    "225c4c80d7ee2302203373b4d283d0417de2a3f27b3470b0137b80001715f99e05284e8b16"
    "ed288540");
  const auto issuing_der = from_hex(
    "3082014f3081f5a00302010202101397ccc4e13819f59adffea8f5aa55ba300a06082a8648"
    "ce3d0403023000301e170d3231303132393035343232305a170d3231303133303035343232"
    "305a30003059301306072a8648ce3d020106082a8648ce3d030107034200045e210200da76"
    "c73e9da9c9c3ff68fb680d12b60633c29cc4ec8aa66e4be2cde4f21e706dd64aaa2adda116"
    "f4d5474d6689a7205835fd5a13ecd46b64a71c807ca351304f300e0603551d0f0101ff0404"
    "030202a4300f0603551d130101ff040530030101ff300d0603551d0e04060404f312fa8f30"
    "1d0603551d110101ff04133011810f7573657240646f6d61696e2e636f6d300a06082a8648"
    "ce3d0403020349003046022100a4f4defca4ed13b781b797707670bdf885d1aa6cf8a5d9ba"
    "586066ada8cca961022100e26d5a5c7cf169e820bb3c5fb1a8e8a9f48678d46cf7d489270c"
    "98546efa46fb");
  const auto leaf_der = from_hex(
    "3082014a3081f2a003020102021003d61b85fa16a9439b2a9c9dcd9ee575300a06082a8648"
    "ce3d0403023000301e170d3231303132393035343232305a170d3231303133303035343232"
    "305a30003059301306072a8648ce3d020106082a8648ce3d03010703420004177f3e44f97d"
    "36df7e7216857e4ce511a2e402376a59d9887b90c59351bd7cca387c0cc22a25038a1532df"
    "ec82b49661ad38ad21acfaca9adb524e3761b1943fa34e304c300e0603551d0f0101ff0404"
    "030202a4300c0603551d130101ff04023000300d0603551d0e04060404db6458df301d0603"
    "551d110101ff04133011810f7573657240646f6d61696e2e636f6d300a06082a8648ce3d04"
    "0302034700304402201dc0f17ab8f980bb8a13ad1003325fe237af78f7338ef2dbf383a493"
    "191217d402203505672d488ea336a70be868ceb69dbd163f437942fb4ea3ef1a844cb4927d"
    "0e");

  const auto pem_string = std::string(R"pem(-----BEGIN CERTIFICATE-----
MIIBTTCB9aADAgECAhA4JH4bo0aOmROrNX2eEGq+MAoGCCqGSM49BAMCMAAwHhcN
MjEwMTI5MDU0MjIwWhcNMjEwMTMwMDU0MjIwWjAAMFkwEwYHKoZIzj0CAQYIKoZI
zj0DAQcDQgAE3qTcS7HJgkxHHv6qsD906yQ+FTiM1d+RKtOrRslzUaQTI5danJhf
vZXXikC0QRNozppM1Nt+s8OWLVmHDLeDv6NRME8wDgYDVR0PAQH/BAQDAgKkMA8G
A1UdEwEB/wQFMAMBAf8wDQYDVR0OBAYEBJJ7ZMYwHQYDVR0RAQH/BBMwEYEPdXNl
ckBkb21haW4uY29tMAoGCCqGSM49BAMCA0cAMEQCIHjoyrIH1M+GAQpeIZPUfBUM
P66+f0X8rdciXEyA1+4jAiAzc7TSg9BBfeKj8ns0cLATe4AAFxX5ngUoTosW7SiF
QA==
-----END CERTIFICATE-----
-----BEGIN CERTIFICATE-----
MIIBTzCB9aADAgECAhATl8zE4TgZ9Zrf/qj1qlW6MAoGCCqGSM49BAMCMAAwHhcN
MjEwMTI5MDU0MjIwWhcNMjEwMTMwMDU0MjIwWjAAMFkwEwYHKoZIzj0CAQYIKoZI
zj0DAQcDQgAEXiECANp2xz6dqcnD/2j7aA0StgYzwpzE7IqmbkvizeTyHnBt1kqq
Kt2hFvTVR01miacgWDX9WhPs1GtkpxyAfKNRME8wDgYDVR0PAQH/BAQDAgKkMA8G
A1UdEwEB/wQFMAMBAf8wDQYDVR0OBAYEBPMS+o8wHQYDVR0RAQH/BBMwEYEPdXNl
ckBkb21haW4uY29tMAoGCCqGSM49BAMCA0kAMEYCIQCk9N78pO0Tt4G3l3B2cL34
hdGqbPil2bpYYGatqMypYQIhAOJtWlx88WnoILs8X7Go6Kn0hnjUbPfUiScMmFRu
+kb7
-----END CERTIFICATE-----
-----BEGIN CERTIFICATE-----
MIIBSjCB8qADAgECAhAD1huF+hapQ5sqnJ3NnuV1MAoGCCqGSM49BAMCMAAwHhcN
MjEwMTI5MDU0MjIwWhcNMjEwMTMwMDU0MjIwWjAAMFkwEwYHKoZIzj0CAQYIKoZI
zj0DAQcDQgAEF38+RPl9Nt9+chaFfkzlEaLkAjdqWdmIe5DFk1G9fMo4fAzCKiUD
ihUy3+yCtJZhrTitIaz6yprbUk43YbGUP6NOMEwwDgYDVR0PAQH/BAQDAgKkMAwG
A1UdEwEB/wQCMAAwDQYDVR0OBAYEBNtkWN8wHQYDVR0RAQH/BBMwEYEPdXNlckBk
b21haW4uY29tMAoGCCqGSM49BAMCA0cAMEQCIB3A8Xq4+YC7ihOtEAMyX+I3r3j3
M47y2/ODpJMZEhfUAiA1BWctSI6jNqcL6GjOtp29Fj9DeUL7TqPvGoRMtJJ9Dg==
-----END CERTIFICATE-----
)pem");

  const auto from_der = std::vector<Certificate>{ Certificate{ root_der },
                                                  Certificate{ issuing_der },
                                                  Certificate{ leaf_der } };

  const auto pem_bytes = bytes(pem_string.begin(), pem_string.end());
  const auto from_pem = Certificate::parse_pem(pem_bytes);

  REQUIRE(from_der == from_pem);
}

TEST_CASE("Test Subject Parsing")
{
  const auto leaf_der = from_hex(
    "3082015e30820110a003020102021100d4a0be6c42e855fa6df8269a5521747f300506032b"
    "6570302a311530130603550403130c637573746f6d3a31323334353111300f060355040513"
    "0831312d32322d3333301e170d3231303231313233353033325a170d323130323132323335"
    "3033325a302a311530130603550403130c637573746f6d3a31323334353111300f06035504"
    "05130831312d32322d3333302a300506032b6570032100b6f359d48609b81ff3eee3546c23"
    "5a5a31c8dd1b84c29bf0d9ea32fad3945299a34b3049300e0603551d0f0101ff0404030202"
    "a4300c0603551d130101ff04023000300d0603551d0e040604048dc683c3301a0603551d11"
    "04133011810f7573657240646f6d61696e2e636f6d300506032b6570034100dcbc8d3431f8"
    "2f7cc7c97672bad001119b6b4bfbd9ee96a1096238d59ff3211529a90a6b148ed874ca1349"
    "5e636388ef623f486c85dc53c3e2377809d7fda004");

  auto leaf = Certificate{ leaf_der };
  CHECK(leaf.raw == leaf_der);
  auto parsed_subject = leaf.subject();
  CHECK_EQ(parsed_subject.size(), 2);
  auto it = parsed_subject.find(Certificate::NameType::common_name);
  CHECK_EQ(it->second, "custom:12345");
  it = parsed_subject.find(Certificate::NameType::serial_number);
  CHECK_EQ(it->second, "11-22-33");
}

TEST_CASE("Test Certificate notBefore status")
{
  // notBefore - 99 years from 04/22/2021
  const auto root_der = from_hex(
    "3082016230820114a00302010202101dcfbd024e5f62ccfb04a1f32e7ce755300506032b65"
    "70302a311530130603550403130c637573746f6d3a31323334353111300f06035504051308"
    "31312d32322d33333020170d3236303330383036333631345a180f32313235303231323036"
    "333631345a302a311530130603550403130c637573746f6d3a31323334353111300f060355"
    "0405130831312d32322d3333302a300506032b6570032100cb6d233470f884eaa6e5a3b958"
    "e7e68eff3fee146432ea526128171a33f8a403a34e304c300e0603551d0f0101ff04040302"
    "02a4300f0603551d130101ff040530030101ff300d0603551d0e0406040459e6b3dd301a06"
    "03551d1104133011810f7573657240646f6d61696e2e636f6d300506032b6570034100308a"
    "a37cfbcd06e19b7a0728c5c970b38df5eb93d478970868ce6398a6a963b2c570edfd9dc62f"
    "4d134de11eca367f9d967d6eae14192454770a2fc278963602");

  auto root = Certificate{ root_der };
  REQUIRE(root.expiration_status() == Certificate::ExpirationStatus::inactive);
}

TEST_CASE("Test Certificate notAfter status")
{
  // notAfter - 2 days older than 04/22/2021
  const auto root_der = from_hex(
    "3082016030820112a00302010202104746a8dc01b0c2a729cb307bd52cd94f300506032b65"
    "70302a311530130603550403130c637573746f6d3a31323334353111300f06035504051308"
    "31312d32322d3333301e170d3231303431383036333831385a170d32313034323130363338"
    "31385a302a311530130603550403130c637573746f6d3a31323334353111300f0603550405"
    "130831312d32322d3333302a300506032b65700321003beb77d095e9bb842d52f3642e4955"
    "b907f1e42129be39db81059860e6ea5c27a34e304c300e0603551d0f0101ff0404030202a4"
    "300f0603551d130101ff040530030101ff300d0603551d0e04060404b2e294f2301a060355"
    "1d1104133011810f7573657240646f6d61696e2e636f6d300506032b6570034100ba82b764"
    "43b126cab7db4a8a054e53ee25ef39d1ef2642931c7961c5591643edf73b25fc2bd7c3527b"
    "e4e7d2b0606050b2e0edcfc8d6390b373e21f08116910b");

  auto root = Certificate{ root_der };
  REQUIRE(root.expiration_status() == Certificate::ExpirationStatus::expired);
}

TEST_CASE("Test Certificate active status")
{
  // notBefore - 2 days older than 04/22/2021
  // notAfter - 99 years from 04/22/2021
  const auto root_der = from_hex(
    "3082016230820114a0030201020210021dca182b9f52f6081841be66a84938300506032b65"
    "70302a311530130603550403130c637573746f6d3a31323334353111300f06035504051308"
    "31312d32322d33333020170d3231303432313036343132385a180f32313230303333303036"
    "343132385a302a311530130603550403130c637573746f6d3a31323334353111300f060355"
    "0405130831312d32322d3333302a300506032b65700321004b16ffec9d6db170f06ca73ec7"
    "64e206c71c57c3f7454b4bd17bcef26c22b7f7a34e304c300e0603551d0f0101ff04040302"
    "02a4300f0603551d130101ff040530030101ff300d0603551d0e0406040488fbad09301a06"
    "03551d1104133011810f7573657240646f6d61696e2e636f6d300506032b6570034100c644"
    "939be90b8121a7e5b371396f89b01235dd8cde01e88d6d7e09fb02ae6c1bb5e5abfe21de96"
    "16a821444907e84cd4fb88167f1c3a4d4911f8260dafb21b05");

  auto root = Certificate{ root_der };
  REQUIRE(root.expiration_status() == Certificate::ExpirationStatus::active);
  CHECK_NOTHROW(root.not_before());
  CHECK_NOTHROW(root.not_after());
  REQUIRE(root.signature_algorithm() == Signature::ID::Ed25519);
  REQUIRE(root.public_key_algorithm() == Signature::ID::Ed25519);
}
